# Как настроить почтовый сервер JES

Для того, чтобы использовать систему уведомлений и возможность импортировать письма электронной почты как задачи, TrackStudio нужен POP3/SMTP сервер. Вы можете использовать для этих целей любой известный вам сервер (или даже почтовый сервис, такой как Gmail или Яндекс.Почта). Для настройки и тестирования вы также можете использовать поставляемый вместе с TrackStudio Standalone преднастроенный **Java E-mail Server** (JES).

## Чтобы использовать JES для отправки уведомлений:

1. Откройте файл **jes/etc/mail.conf** в текстовом редакторе. Раскомментируйте параметр **defaultsmtpservers** и укажите адрес SMTP-сервера вашей организации.
2. Запустите Java E-mail Server (**jes/jes**). (Для запуска под ОС GNU/Linux используйте команду **sudo sh jes**
3. Запустите приложение для управления сервером TrackStudio (SMAN).
4. Перейдите на вкладку "**Электронная почта**", а затем на "**Оповещения по электронной почте**".
5. Включите опцию "**Разрешить оповещения по электронной почте**". Остальные параметры не меняйте.
6. Укажите порт для SMTP-сервера. Обычно это порт 25 (в таком случае поле можно оставить пустым), но если такой порт уже занят, вы можете указать другой в файле **jes/etc/mail.conf**
7. Нажмите кнопку "**Старт**" и дождитесь окончания запуска TrackStudio.
8. Войдите в систему через ваш браузер под вашей учетной записью.
9. Укажите ваш адрес электронной почты в настройках пользователя (Чтобы перейти к настройкам своей учетной записи, кликните на вашем имени в приветствии вверху страницы в TrackStudio и затем нажмите кнопку "**Редактировать**").
10. Перейдите к проекту, для которого вы хотите создать уведомление.
11. В меню выберите пункт "**Оповещения о событиях**" (если такого пункта меню нет, значит вы не включили в Server Manager возможность отправлять оповещения.
12. Создайте оповещение о событиях, как это описано в статье документации "[Как оповещать пользователей об изменениях по e-mail](howto-notify-users.md)"

Как это работает:

1. Кто-то из пользователей изменяет или добавляет задачу, выполняет над задачей операцию или оставляет комментарий.
2. Если указанная задача удовлетворяет условиям фильтра, заданного для оповещения, TrackStudio создает сообщение электронной почты и отправляет его через указанный SMTP-сервер (в данном случае JES) подписчикам, для которых создано это оповещение.
3. JES перенаправляет это сообщение на сервер, указанный в параметре **defaultsmtpservers** в файле **mail.conf**.
4. Почтовый сервер отправляет сообщения в ящики электронной почты пользователей.
5. Затем пользователи получают это сообщение с помощью своих почтовых клиентов.

## Чтобы использовать JES для приема сообщений электронной почты:

1. Настройте JES для отправки уведомлений, как описано выше и убедитесь, что оповещения доходят до адресатов.
2. Запустите Java E-mail Server (**jes/jes**). (Для запуска под ОС GNU/Linux используйте команду **sudo sh jes**
3. Запустите приложение для управления сервером TrackStudio (SMAN).
4. Перейдите на вкладку "**Электронная почта**", а затем на "**Регистрация задач и сообщений по электронной почте**".
5. Включите опцию "Разрешить импорт e-mail"
6. Укажите периодичность импорта в минутах. При тестировании лучше указать минимальную периодичность в 1 минуту, чтобы не приходилось долго ждать обработки писем в очереди.
7. Укажите адрес почтового сервера (для целей тестирования можно оставить 127.0.0.1)
8. Укажите порт для POP3-сервера. Обычно это порт 110 (в таком случае поле можно оставить пустым), но если такой порт уже занят, вы можете указать другой в файле **jes/etc/mail.conf**
9. Нажмите кнопку "**Старт**" и дождитесь окончания запуска TrackStudio.

Как это работает:

1. Пользователь отправляет письмо на адрес trackstudio@127.0.0.1.
2. JES определяет, что адрес получателя находится в локальном домене и пересылает его в соответствующий внутренний ящик, который используется TrackStudio
3. Когда TrackStudio определяет наличие сообщения в ящике, она обрабатывает его и, в зависимости от результатов обработки, создает задачу или комментарий к задаче.

Для тестирования вы можете создать почтовые ящики для существующих пользователей TrackStudio на сервере JES. Для этого:

1. Остановите сервер JES
2. Откройте файл **jes/etc/user.conf**
3. Создайте в нем записи вида **user.username@localhost=<password>**
4. Запустите сервер JES.
5. В почтовом клиенте укажите логин username@localhost и заданный пароль.

Подробнее о настройке импорта задач из электронной почты читайте в статье "[Как импортировать письма от пользователей в задачи](howto-import-email.md)"

## Отладка работы системы почтовых уведомлений

Логи работы почтового сервера Java Email Server находятся в файле **jes/log/jes.log**. Вы можете настроить вывод этих логов в файле**jes/etc/log.conf** (это обычный конфигурационный файл логгера log4j). Для отладки лучше использовать уровень **debug**.

Очередь отправки сообщений можно посмотреть в папке **jes/etc/smtp** вашего экземпляра TrackStudio. Если в этой папке есть файлы с расширением **.ser** и они из нее не исчезают, значит какие-то сообщения сервер **jes** не может отправить. Вы можете открыть файл с расширением **.ser** в любом текстовом редакторе и посмотреть, от кого и кому это письмо.

После приема почты сервером JES сообщения раскладываются в папки, соответствующие ящикам учетных записей. Так, например, сообщения для **analyst@localhost** будут складироваться в папку **jes/etc/users/analyst@localhost** в виде текстовых файлов, пока не будут удалены самим получателем из почтового клиента.

Для того, чтобы посмотреть логи отправки почтовых сообщений системой TrackStudio, либо посмотреть логи импорта сообщений, в файле **trackstudio.mail.properties** установите параметр **mail.debug=true**.

После запуска TrackStudio в файл **trackstudio.log** будут писаться сообщения логгера.
